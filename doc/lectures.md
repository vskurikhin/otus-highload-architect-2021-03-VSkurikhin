[![hits](https://hits.deltapapa.io/github/vskurikhin/otus-highload-architect-2021-03-VSkurikhin.svg)](https://hits.deltapapa.io)

# Лекции

## [Лекции](lectures.md)

1. [Проблемы высоких нагрузок](lectures.md#проблемы-высоких-нагрузок)
    - [Особенности работы операционной системы • Модели веб-серверов](lectures.md#особенности-работы-операционной-системы-•-модели-веб-серверов)
    - [Возможности языковых платформ](lectures.md#возможности-языковых-платформ)
    - [Трехзвенная архитектура](lectures.md#трехзвенная-архитектура)
    - [Полезные ссылки](lectures.md#полезные-ссылки)
2. [Нагрузочное тестирование](lectures.md#нагрузочное-тестирование)
    - [НТ - события и цели НТ](lectures.md##нт---события-и-цели-нт)
    - [Профиль НТ, основные этапы](lectures.md#профиль-нт-основные-этапы)
    - [Работа в Jmeter](lectures.md#работа-в-jmeter)
3. [Введение в высокие нагрузки](lectures.md#введение-в-высокие-нагрузки)

### [Проблемы высоких нагрузок](https://otus.ru/lessons/highloadarchitect/?int_source=courses_catalog&int_term=programming)

#### Особенности работы операционной системы • Модели веб-серверов

##### Стандартный сценарий

Имеется компьютер с одним 4-хядерным процессором, на котором запущены: chrome, skype, zoom, telegram, slack, ... Как это вяжется с представлением о том, что на одном ядре выполняется 1 программа?

##### Передача управления

Операционная система выделяет для выполнения программы квант времени (~50 мкс), затем происходит прерывание и переключение контекста. Переключение контекста происходит и при любом системном вызове.

##### Переключение контекста (context switch)

Сохранение:
- Регистров процессора
- Общей информации: pid, tid, uid, gid, euid, egid, ...
- Состояния процесса/потока
- Прав доступа
- Используемых потоком ресурсов и блокировок
- Счетчиков использованных ресурсов (например, таймеров процессорного времени)
- Регионов памяти, выделенных процессу

Очистка:
- Конвейера команд и данных процессора
- TLB, отвечающего за страничное отображение линейных адресов на физические

Вывод: переключение контекста – дорогая операция (~1 мкс, тогда как выполнение простой строчки кода занимает ~0.5 нс)

##### Процессы и потоки

- В Linux практически одно и тоже
- Потоки имеют общую память

Какими системными вызовами создаются потоки и процессы?
- clone(child_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7fa001a93a10) = 6916 [fork()]
- clone(child_stack=0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SYSVSEM|CLONE _SIGHAND|CLONE_THREAD|CLONE_SETTLS|CLONE_PARENT_S child_tidptr=0x7fa001a93a10) = 6916 [pthread_create()]

##### strace

Позволяет трассировать процесс и наблюдать выполняемые им системные вызовы.

##### Память

- Память разбивается на однотипные куски одинакового размера 4 кБ (иногда 4 МБ)
- Аллокация памяти происходит при первом обращении
- Со включенным режимом swap возможна подкачка памяти с HDD (на проде желательно выключать)

##### Кейсы

- Процессиспользует1Тбпамяти,намашине4ГбОЗУ.Чтопроизойдет?
- Код занимает 1 Мб, данные 1 Мб. Сколько нужно памяти после fork’а?
- А после изменения данных?
- Redis работает на машине со включенным huge-pages в персистентном режиме. При этом иногда тормозит. Почему?

##### Модели веб-серверов

- Worker(многопоточный)
- Prefork (многопроцессный) • Асинхронный
- Комбинированный 

##### Worker vs prefork

- Потокиэкономятпамять
- Переключать потоки дешевле
- Потокисложнеесинхронизировать

##### Worker и prefork

Преимущества:
- Простота

Недостатки:
- Неэффективность при интенсивной работе с I/O (увеличение числа обработчиков – не вариант)
- Ограниченность размером пула числа клиентов, обслуживаемых одновременно
- Дороговизна выделения по обработчику на каждого клиента

##### Асинхронный веб-сервер

- Основан на однопоточном событийном цикле и шаблоне «reactor»
- Цикл событий читает события, представленные в виде callback’ов, из очереди с приоритетом (приоритет – время готовности)
- Клиентский код, инициируя операцию I/O, регистрирует callback в очереди
- Цикл событий опрашивает дескрипторы, ожидающие I/O, обновляет приоритеты в очереди
- В конце callback’а возвращаем управление циклу событий

Преимущества:
- Можно обрабатывать одновременно большое количество клиентов
- Отсутствуетпереключениеконтекста

Недостатки:
- Потребляетнебольшеодногопроцессорногоядра(лечится применением комбинированной модели)
- Клиенты связаны одним потоком (утечки памяти, блокировки, ошибки, действия, нагружающие процессор недопустимы)
- Код становится сложнее

##### Комбинированный веб-сервер

- Имеетпулпроцессов,каждыйизкоторыхзапускаетпулпотоков, каждый из которых использует модель обработки на основе асинхронного ввода-вывода
- Применяется в реальных серверах (nginx и apache http server в режиме MPM event)



#### Возможности языковых платформ

##### Дальнейшее развитие

Асинхронный код:
- Быстрый
- Потребляетмалопамяти
- Сложно писать 

Синхронный код:
- Медленный
- Потребляетмногопамяти
- Просто писать

Соединим концепции на уровне языковых платформ или библиотек (fibers, green threads, goroutines).

##### Концепция fiber’ов

- Совмещаемплюсысинхроннойиасинхронноймодели
- Пишем свой более легковесный планировщик (программа будет иметь линейный вид)
- Оставляем машину событий (получаем быстродействие)

##### Perl

- Обычно работает внутри apache
- Синхронный язык с поддержкой thread’ов (редко)
- Есть библиотека AnyEvent
- Есть библиотека для fiber’ов
- Да,онвсеещежив

##### python

- Есть потоки
- Есть fiber
- Процесс с потоками в python может использовать 1 ядро (GIL)

##### NodeJS

- Синхронный код
- Строго однопоточный
- Надо поднимать много процессов 
- Сложно писать

##### Go

- Концепциязеленыхпотоков
- Умеет использовать столько ядер CPU, сколько нужно • Ориентированнамикросервисы
- Быстрый

#### Трехзвенная архитектура

#### Полезные ссылки
| Название | Дата |
| -------- | ---- |
| [1. Что такое «асинхронная событийная модель», и почему сейчас она «в моде»](https://habr.com/ru/post/128772/) | 2011-09-20 |
| [2. Is this explanation about VSS/RSS/PSS/USS accurate?](https://stackoverflow.com/questions/22372960/is-this-explanation-about-vss-rss-pss-uss-accurate) | 2017-04-30 |
| [3. Node.js multithreading: What are Worker threads, and why do they matter?](https://blog.logrocket.com/node-js-multithreading-what-are-worker-threads-and-why-do-they-matter-48ab102f8b10/) | 2019-01-31 |

### [Нагрузочное тестирование](https://otus.ru/lessons/highloadarchitect/?int_source=courses_catalog&int_term=programming)

#### НТ - события и цели НТ

Нагрузочное тестирование начинается с события и цели:

Примеры: Событие «Выпускаем новое ПО / новый релиз», Цель «Нормально ли будет работать под нагрузкой?».

Событие «Выбираем новое железо», Цель «Выяснить какое лучше?»

Событие «Подключаем новый мониторинг», Цель «А не заглючит ли Система с ним вместе?»

1. Выпуск нового ПО;
2. Новый релиз имеющегося ПО;
3. Исследование и устранение проблем прода;
4. Постепенное накопление изменений в системе;
5. Ожидается рост нагрузки на систему (например, после рекламной кампании);
6. Замена оборудования;
7. Оценка влияния мониторинга.

#### Профиль НТ, основные этапы

Нагрузочное тестирование преследует цели:

Основные:
1. Определение максимальной производительности;
2. Выявление «узких мест»;
3. Проверка надежности.

Дополнительные:
4. Проверка отказоустойчивости;
5. Оценка влияния мониторинга;
6. Подбор оптимальной конфигурации комплекса технических средств;
7. Воспроизведение проблем промышленной среды;
8. Проверка исправления ошибки;
9. Проверка влияния стресс-нагрузки.

Определить событие и цели для будущего НТ

1. АС Банк-клиент-онлайн, выпуск нового модуля на новом железе
2. Поисковик Яндекса, 10(?) релизов в день, мощная отказоустойчивость, множество рисков
3. АРМ “Заказ справок” села Полунье, последнее обновление 2 года назад (разработчик-сисадмин уехал на вахту)

Основные этапы НТ

1. Постановка задач (1день – 1 неделя)\
   Содержит событие, цель, описание системы, имеющиеся данные по нагрузке
2. Подготовка стенда (1 неделя – 1 месяц)\
   Идеально = продуктивному для снижения рисков пропуска дефектов
3. Подготовка методики НТ (1 – 2 недели)\
   Подробное описание в плюс к постановке - какие операции с каким профилем, какие тесты, какой мониторинг и т.д. (См. шаблон)
4. Разработка / актуализация средств НТ (1 неделя – 3 месяца)\
   эмуляторы для внешних систем, мониторинг для компонент
   и конечно - сами скрипты с эмуляцией “разнообразия” в разумных предела
5. Проведение тестов (1 неделя – 2 месяца)
   начинать со смоук-теста, далее по методике
   стандартный тест - поиск максимума
6. Анализ результатов и подготовка отчета (1 неделя – 1 месяц)\
   Проверка критериев работоспособности и поиск причин их нарушения
7. Повторить 4-6 до полного удовлетворения (или пока не кончатся средства)

Профиль НТ - это набор операций с заданными интенсивностями, полученный на основе сбора 
статистических данных либо определенный путем анализа требований к тестируемой системе

1. Существующая система - статистика!*
   - Выгрузка статистики основных операций
   - Отбираем типичные высоконагруженные дни и усредняем данные по таким дням
   - Берем пиковый час таких дней (например, 10-11 утра)
   - Отбираем наиболее интенсивные операции + «тяжёлые» и критичные операции.
2. Новая система – нет статистики?
   - Используем вместо статистики Бизнес-прогнозы
     Проверяем, соответствует ли ПО своему ТЗ на поизводительность

* Не исключаем несколько профилей нагрузки для системы (закрытие периодов / отчетность и т.п.)
** Не забываем про стресс-нагрузку в событиях / при открытии

#### Работа в Jmeter

1. Java (jre)
2. Скачать Jmeter
3. Плагины:
   - Jmeter plugin Manager
   - Throughput Shaping Timer – управление интенсивностью нагрузки
   - Dummy Sampler – удобный плагин для отладки
   - Custom Thread Groups – управление количеством VU
   - Random CSV Data Set – работа с пулами данных
   - 3 Basic Graphs – оценка результатов тестов
4. А так же:
   - InfluxDB – хранение результатов тестов
   - Grafana – визуализация результатов тестов

1. User Interface Jmeter - Run, Clear, Plugin Manager, Errors, Function helper
2. Script recording - HAR files
3. Thread Group - SetUp TG, Number, Ramp-up, Loop Count and Duration
4. HTTP request Sampler - Basic/Advanced settings
5. Config Elements - CSV Data Set config, User defined variables, HTTP Cookie Manager, HTTP Header Manager
6. Listeners - View Result tree, Aggregate report, Backend listner
7. Controllers - Transaction controller, loop controller
8. Timers - Constant throughput
9. Variables and Properties
10. Post Processors - RegEx ,JSON Path, Boundary Extractor, Xpath
11. Console Run
12. Base report


### [Введение в высокие нагрузки](https://otus.ru/lessons/highloadarchitect/?int_source=courses_catalog&int_term=programming)

В чем мерить нагрузку?

Вариант № 1\
Колличество запросов в единицу времени:
- rps
- rpm

Вариант № 2\
Колличество данных в единицу времени: packets per second:
- megabytes per second

Какие здесь могут быть проблемы?

новременных соединений: Simultaneous connections Concurrency

График нагрузки

- Latency - Время, которое проходит от запроса, до получения ответа. Чем оно ниже, тем лучше.
- Throughput - Пропускная способность системы. Например, сколько писем могут принимать наши сервера.

Latency vs throughput\
В реальных проектах приходится выбирать между этими параметрами В highload-системах, как правило, предпочтение отдают 
throughput Причины выбора - разные архитектуры.

- Правильно измерять перцентиль. Как правило 95 или 99.
- Перцентиль (процент) — значение антропометрического признака для сотой доли совокупности измеренных людей.
  Если кривую распределения всей совокупности измеренных людей разделить на 100 равных частей, то получим 99 площадей,
  в каждой из которых будет свое значение признака и частота ее встречаемости.

Виды масштабирования
- Вертикальное - увеличение мощности сервера.
- Горизонтальное - использование бОльшего колличества серверов.
