version: "3.8"
services:
  my-mysql-0:
    image: mysql:8.0.23
    container_name: my-mysql-0
    restart: "no"
    environment:
      MYSQL_DATABASE: hl
      MYSQL_USER: hl
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: 'password'
    command: >
      --general-log=ON
      --log-queries-not-using-indexes=ON
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 384M
    networks:
      ab_subnet:
        aliases:
          - my-mysql-1.localhost
    ports:
      - 3360:3306
    volumes:
      - my-mysql-0-data:/var/lib/mysql
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/cgroup:ro
      - /volumes/my-mysql-0/conf.d:/etc/mysql/conf.d

  my-mysql-1:
    image: mysql:8.0.23
    container_name: my-mysql-1
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: hl
      MYSQL_USER: hl
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: 'password'
    command: >
      --general-log=ON
      --log-queries-not-using-indexes=ON
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 384M
    networks:
      ab_subnet:
        aliases:
          - my-mysql-1.localhost
    ports:
      - 3361:3306
    volumes:
      - my-mysql-1-data:/var/lib/mysql
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/cgroup:ro
      - /volumes/my-mysql-1/conf.d:/etc/mysql/conf.d

  my-mysql-2:
    image: mysql:8.0.23
    container_name: my-mysql-2
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: hl
      MYSQL_USER: hl
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: 'password'
    command: >
      --general-log=ON
      --log-queries-not-using-indexes=ON
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 384M
    networks:
      ab_subnet:
        aliases:
          - my-mysql-2.localhost
    ports:
      - 3362:3306
    volumes:
      - my-mysql-2-data:/var/lib/mysql
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/cgroup:ro
      - /volumes/my-mysql-2/conf.d:/etc/mysql/conf.d

  my-haproxy:
    image: haproxy:2.1.7
    container_name: haproxy-lb
    restart: "no"
    depends_on:
      - my-mysql-0
      - my-mysql-1
      - my-mysql-2
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          memory: 128M
    networks:
      ab_subnet:
        aliases:
          - my-haproxy.localhost
    volumes:
      - "./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg"
    ports:
      - "3306:3306"
      - "8404:8404"

  my-app-dialog-1:
    image: vskurikhin/app-dialog-amd64
    container_name: my-app-dialog-1
    restart: "no"
    depends_on:
      - my-haproxy
    environment:
      DB_HOST_RW: my-mysql-0
      DB_PORT_RW: 3306
      DB_HOST_RO: my-haproxy
      DB_PORT_RO: 3306
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      - ab_subnet

  my-app-dialog-2:
    image: vskurikhin/app-dialog-amd64
    container_name: my-app-dialog-2
    restart: "no"
    depends_on:
      - my-haproxy
    environment:
      DB_HOST_RW: my-mysql-0
      DB_PORT_RW: 3306
      DB_HOST_RO: my-haproxy
      DB_PORT_RO: 3306
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      - ab_subnet

  my-app-main-1:
    image: vskurikhin/app-main-amd64
    container_name: my-app-main-1
    restart: "no"
    depends_on:
      - my-haproxy
    environment:
      DB_HOST_RW: my-mysql-0
      DB_PORT_RW: 3306
      DB_HOST_RO: my-haproxy
      DB_PORT_RO: 3306
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      - ab_subnet

  my-app-main-2:
    image: vskurikhin/app-main-amd64
    container_name: my-app-main-2
    restart: "no"
    depends_on:
      - my-haproxy
    environment:
      DB_HOST_RW: my-mysql-0
      DB_PORT_RW: 3306
      DB_HOST_RO: my-haproxy
      DB_PORT_RO: 3306
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      - ab_subnet

  my-nginx:
    image: nginx:1.19.0
    container_name: nginx-lb
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      - ab_subnet
    volumes:
      - "./nginx/nginx.conf:/etc/nginx/conf.d/default.conf"
    ports:
      - "8080:80"
      - "8888:8888"

  my-cdc-producer:
    image: vskurikhin/cdc-producer
    container_name: my-cdc-producer
    restart: on-failure
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      DATABASE_HOSTNAME: my-mysql-0
      DATABASE_PORT: 3306
      DEBEZIUM_BOOTSTRAP_SERVERS: kafka:9092
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    networks:
      ab_subnet:
        aliases:
          - my-cdc-producer.localhost
        ipv4_address: 172.16.1.218

  my-consul-0:
    image: consul:latest
    container_name: my-consul-0
    command: 'agent -dev -client=0.0.0.0 -bind=0.0.0.0'
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      ab_subnet:
        aliases:
          - my-consul-0.localhost
    ports:
      - '8500:8500'
      - '8600:8600/tcp'
      - '8600:8600/udp'
    volumes:
      - ./20-agent-0.json:/consul/config/20-agent.json

  my-consul-1:
    image: consul:latest
    container_name: my-consul-1
    command: 'agent -dev -client=0.0.0.0 -bind=0.0.0.0'
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      ab_subnet:
        aliases:
          - my-consul-1.localhost
    volumes:
      - ./20-agent-1.json:/consul/config/20-agent.json

  my-consul-2:
    image: consul:latest
    container_name: my-consul-2
    command: 'agent -dev -client=0.0.0.0 -bind=0.0.0.0'
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      ab_subnet:
        aliases:
          - my-consul-2.localhost
    volumes:
      - ./20-agent-2.json:/consul/config/20-agent.json

  my-zabbix:
    image: zabbix/zabbix-appliance:latest
    container_name: my-zabbix
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 128M
    networks:
      ab_subnet:
        aliases:
          - my-zabbix.localhost
    ports:
      - 80:8080
      - 10051:10051
    volumes:
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/cgroup:ro

  my-zabbix-agent:
    image: local/zabbix-agent-mysql:latest
    container_name: my-zabbix-agent
    privileged: true
    hostname: my-zabbix-agent
    domainname: localhost
    networks:
      ab_subnet:
        aliases:
          - my-zabbix-agent.localhost
        ipv4_address: 172.16.1.11
    extra_hosts:
      - "localhost
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 64M
    volumes:
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/cgroup:ro
      - /volumes/my-zabbix-agent/zabbix_agentd.conf:/etc/zabbix/zabbix_agentd.conf:ro
      - /volumes/my-zabbix-agent/zabbix_agentd.d:/etc/zabbix/zabbix_agentd.d:rw
    tmpfs:
      - /run
      - /tmp
    ports:
      - 20050:10050
    links:
      - my-zabbix

  my-nginx-prometheus-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: my-nginx-prometheus-exporter
    restart: on-failure
    environment:
      - SCRAPE_URI=http://my-nginx/stub_status
    depends_on:
      - my-nginx
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
    networks:
      - ab_subnet

  my-prometheus:
    image: prom/prometheus:v2.17.1
    container_name: my-prometheus
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    expose:
      - 9090
    ports:
      - '9090:9090/tcp'
    networks:
      ab_subnet:
        aliases:
          - my-prometheus.localhost

  my-grafana:
    image: grafana/grafana:6.7.2
    container_name: my-grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=${ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    restart: unless-stopped
    expose:
      - 3000
    ports:
      - '3000:3000/tcp'
    networks:
      ab_subnet:
        aliases:
          - my-grafana.localhost

volumes:
  my-mysql-0-data:
  my-mysql-1-data:
  my-mysql-2-data:
  prometheus_data:
  grafana_data:

networks:
  ab_subnet:
    external: true

